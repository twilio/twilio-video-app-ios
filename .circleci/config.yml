version: 2

# Yaml Defines
aliases:
  - &secrets
    name: Secrets!!!
    command: |
      mkdir -p VideoApp/VideoApp/Credentials || true
      base64 -D <<< $GOOGLE_SERVICE_INFO_PLIST -o VideoApp/VideoApp/Credentials/GoogleService-Info.plist
      base64 -D <<< $TWILIO_CREDENTIALS -o VideoApp/VideoApp/Credentials/TwilioCredentials.json

  - &macos-defaults
    macos:
      xcode: "11.0.0"

  # Filters
  - &build-filter
    branches:
      ignore:
        # All temporary work should be in a branch starting with WIP/
        - /WIP\/.*/

  - &pr-filter
    branches:
      ignore:
        # All temporary work should be in a branch starting with WIP/
        - /WIP\/.*/
        # This is the collection of our "special" branches that we only build with snapshots
        - master
        - "1.0"
        - "2.0"
        - /feature\/.*/

jobs:
  build_and_test_video_twilio:
    <<: *macos-defaults
    steps:
      - checkout
      - run: bundle install --path vendor/bundle
      - run:
          name: Fetch CocoaPods Specs
          command: |
            curl https://cocoapods-specs.circleci.com/fetch-cocoapods-repo-from-s3.sh | bash -s cf
      - run:
          name: Install CocoaPods
          command: |
            bundle exec pod install
      - run: *secrets
      - run:
          command: Scripts/build-app.sh
          no_output_timeout: 30m
    environment:
      - CONFIGURATION=Debug
      - IOS_APP=VideoApp-Twilio
  build_video_community:
      - run:
          command: Scripts/build-app.sh
          no_output_timeout: 30m
    environment:
      - CONFIGURATION=Debug
      - IOS_APP=VideoApp-Community

workflows:
  version: 2
  build-deploy:
    jobs:
      - build_and_test_video_twilio
      - build_video_community
