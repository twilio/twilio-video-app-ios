version: 2.1

aliases:
  - &test_filters
    branches:
      ignore:
        - master
        - /WIP\/.*/

executors:
  macos_executor:
    macos:
      xcode: "11.2.0"

commands:
  setup:
    steps:
      - checkout
      - run:
          name: Install secrets
          command: base64 -D \<<< $SECRETS_TAR | tar -x
      - restore_cache:
          key: v1-gems-{{ checksum "Gemfile.lock" }}
      - run:
          name: Install gems  
          command: bundle check || bundle install --path vendor/bundle
      - save_cache:
          key: v1-gems-{{ checksum "Gemfile.lock" }}
          paths:
            - vendor/bundle
  test:
    parameters:
      scheme:
        type: string
    steps:
      - setup
      - run:
          name: Test
          command: bundle exec fastlane test scheme:<< parameters.scheme >>
      - store_artifacts:
          path: "~/Library/Logs/scan"
          destination: "scan"
  build_for_test:
    parameters:
      scheme:
        type: string
    steps:
      - setup
      - run:
          name: Test
          command: bundle exec fastlane build_for_test scheme:<< parameters.scheme >>
      - persist_to_workspace:
          root: DerivedData/
          paths:
            - "**/*"
      - store_artifacts:
          path: "~/Library/Logs/scan"
          destination: "scan"
  run_ui_tests:
    parameters:
      scheme:
        type: string
    steps:
      - setup
      - attach_workspace:
          at: /tmp/workspace
      - run:
          name: Setup new DerivedData folder
          command: |
              mkdir DerivedData
              cp -r /tmp/workspace/ DerivedData/
      - run:
          name: Test
          command: bundle exec fastlane run_ui_tests scheme:<< parameters.scheme >>
      - store_artifacts:
          path: "~/Library/Logs/scan"
          destination: "scan"
  beta:
    steps:
      - setup
      - run:
          name: Setup code signing
          command: sh .circleci/setup_code_signing.sh
      - run:
          name: Deploy to App Center
          command: bundle exec fastlane beta
      - store_artifacts:
          path: "~/Library/Logs/gym"
          destination: "gym"

jobs:
  test_twilio_app:
    executor: macos_executor
    steps:
      - test:
          scheme: Video-TwilioUITests
  test_community_app:
    executor: macos_executor
    steps:
      - test:
          scheme: Video-Community
  test_internal_app:
    executor: macos_executor
    steps:
      - test:
          scheme: Video-Internal
  deploy_internal_app_beta:
    executor: macos_executor
    steps:
      - beta
  build_for_test:
    executor: macos_executor
    steps:
      - build_for_test:
          scheme: Video-Twilio
  run_ui_tests:
    executor: macos_executor
    steps:
      - run_ui_tests:
          scheme: Video-TwilioUITests

workflows:
  version: 2
  build_and_test:
    jobs:
      - build_for_test
      - run_ui_tests:
          filters: *test_filters
          requires: 
            - build_for_test
      # - test_community_app:
      #     filters: *test_filters
      # - test_internal_app:
      #     filters: *test_filters
      # - deploy_internal_app_beta:
      #     filters:
      #       branches:
      #         only:
      #           - master
