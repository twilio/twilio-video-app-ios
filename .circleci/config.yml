version: 2.1

# Yaml Defines
aliases:
  - &pr-filters
    branches:
      ignore:
        - master
        - /WIP\/.*/

executors:
  macos_executor:
    macos:
      xcode: "11.0.0"

commands:
  setup_steps:
    description: Setup steps
    steps:
      - checkout
      - run:
          name: Install credentials
          command: |
            mkdir -p VideoApp/VideoApp/Credentials || true
            base64 -D \<<< $GOOGLE_SERVICE_INFO_PLIST -o VideoApp/VideoApp/Credentials/GoogleService-Info.plist
            base64 -D \<<< $TWILIO_CREDENTIALS -o VideoApp/VideoApp/Credentials/TwilioCredentials.json
      - run: 
          name: Install gems  
          command: bundle install --path vendor/bundle
      - run:
          name: Fetch CocoaPods Specs
          command: |
            curl https://cocoapods-specs.circleci.com/fetch-cocoapods-repo-from-s3.sh | bash -s cf
      - run:
          name: Install CocoaPods
          command: |
            bundle exec pod install
  build_stuff:
    description: Build
    steps:
      - run:
          name: Build
          command: |
            xcodebuild \
              -workspace VideoApp.xcworkspace \
              -scheme "Video-Internal" \
              -sdk iphonesimulator \
              -destination 'platform=iOS Simulator,name=iPhone 11,OS=13.0' \
            | xcpretty

jobs:
  build_and_test_video_twilio:
    executor: macos_executor
    steps:
      - setup_steps
      - run:
          name: "Test"
          command: Scripts/build-app.sh
          no_output_timeout: 30m
    environment:
      - CONFIGURATION=Debug
      - IOS_APP=VideoApp-Twilio
  build_video_community:
    executor: macos_executor
    steps:
      - setup_steps
      - run:
          name: "Test"
          command: Scripts/build-app-community.sh
          no_output_timeout: 30m
  build_video_internal:
    executor: macos_executor
    steps:
      - setup_steps
      - build_stuff

workflows:
  version: 2.1
  build-and-test:
    jobs:
      - build_and_test_video_twilio
      - build_video_community
      - build_video_internal
