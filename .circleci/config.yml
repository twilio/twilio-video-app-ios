version: 2

# Yaml Defines
aliases:
  - &secrets
    name: Secrets!!!
    command: |
      mkdir -p VideoApp/VideoApp/Credentials || true
      base64 -D <<< $GOOGLE_SERVICE_INFO_PLIST -o VideoApp/VideoApp/Credentials/GoogleService-Info.plist
      base64 -D <<< $TWILIO_CREDENTIALS -o VideoApp/VideoApp/Credentials/TwilioCredentials.json

  - &log-hw-info
    name: Log HW info
    command: |
      sysctl hw

  - &macos-defaults
    macos:
      xcode: "11.0.0"

  # Reset Ruby
  - &reset-ruby
    name: Reset to system ruby
    command: |
      echo "system" > .ruby-version
      chruby system

  - &install-brew-deps
    name: Install awscli, carthage and maven via Homebrew
    command: Scripts/ci/install-brew-deps.sh
      
  # Homebrew dependencies cache
  - &brew-deps-cache-key
    key: brew-deps-{{ checksum "Scripts/ci/install-brew-deps.sh" }}
  - &restore-cache-brew-deps
    <<: *brew-deps-cache-key
    name: Restoring Homebrew dependencies from the cache
  - &save-cache-brew-deps
    <<: *brew-deps-cache-key
    name: Saving Homebrew dependencies to the cache
    paths:
      # Minimal cache of the dependencies installed via Homebrew.
      # `brew link` will be used to restore the symlinks.
      - /usr/local/Cellar/maven
      - /usr/local/Cellar/awscli
      - /usr/local/Cellar/openssl
      - /usr/local/Cellar/python
      - /usr/local/Cellar/readline
      - /usr/local/Cellar/sqlite

  # Filters
  - &build-filter
    branches:
      ignore:
        # All temporary work should be in a branch starting with WIP/
        - /WIP\/.*/

  - &pr-filter
    branches:
      ignore:
        # All temporary work should be in a branch starting with WIP/
        - /WIP\/.*/
        # This is the collection of our "special" branches that we only build with snapshots
        - master
        - "1.0"
        - "2.0"
        - /feature\/.*/

  - &snapshot-filter
    branches:
      only:
        - master
        - "1.0"
        - "2.0"
        - /feature\/.*/

jobs:
  # Debug build of VideoApp-Twilio
  build:
    <<: *macos-defaults
    steps:
      - run: *log-hw-info
      - checkout
      - restore_cache:
          key: 1-gems-{{ checksum "Gemfile.lock" }}
      - run: bundle check || bundle install --path vendor/bundle
      - save_cache:
          key: 1-gems-{{ checksum "Gemfile.lock" }}
          paths:
            - vendor/bundle
      - run:
          name: Fetch CocoaPods Specs
          command: |
            curl https://cocoapods-specs.circleci.com/fetch-cocoapods-repo-from-s3.sh | bash -s cf
      - run:
          name: Install CocoaPods
          command: |
            bundle exec pod install
      - run: *reset-ruby
      # - restore-cache: *restore-cache-brew-deps
      # - run: *install-brew-deps
      # - save-cache: *save-cache-brew-deps
      # - restore-cache: *restore-video-app-carthage-deps-cache
      # - run: *install-video-app-deps
      # - save-cache: *save-video-app-carthage-deps-cache
      - run: *secrets
      - run:
          command: chruby system
      - run:
          command: Scripts/build-app.sh
          no_output_timeout: 30m
    environment:
      - CONFIGURATION=Debug
      - IOS_APP=VideoApp-Twilio

