version: 2

# Yaml Defines
aliases:
  - &secrets
    name: Secrets!!!
    command: |
      # Untar secrets
      # openssl aes-256-cbc -K $encrypted_120cc09cf48f_key -iv $encrypted_120cc09cf48f_iv -in secrets.tar.enc -out secrets.tar -d
      # tar -xvf secrets.tar

      # Xcode Signing
      # ./Scripts/ci/configure-keychain.sh
      # mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles || true
      # cp secrets/Provisioning\ Profiles/*.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/

      # Credentials
      mkdir -p VideoApp/VideoApp/Credentials || true
      # $GOOGLE_SERVICE_INFO_PLIST | base64 --decode > VideoApp/VideoApp/Credentials/GoogleService-Info.plist
      # $TWILIO_CREDENTIALS | base64 --decode > VideoApp/VideoApp/Credentials/TwilioCredentials.json
      base64 -D <<< $GOOGLE_SERVICE_INFO_PLIST -o VideoApp/VideoApp/Credentials/GoogleService-Info.plist
      base64 -D <<< $TWILIO_CREDENTIALS -o VideoApp/VideoApp/Credentials/TwilioCredentials.json

  - &log-hw-info
    name: Log HW info
    command: |
      sysctl hw

  - &git-user-config
    name: Git User Config
    command: |
      git config --global user.email "twilio-sdk-build@twilio.com"
      git config --global user.name "twilio-sdk-build"

  - &macos-defaults
    macos:
      xcode: "11.0.0"

  # TODO: Use 11.1.0 once the beta images are available.
  - &macos-beta
    macos:
      xcode: "11.0.0"

  # Reset Ruby
  - &reset-ruby
    name: Reset to system ruby
    command: |
      echo "system" > .ruby-version
      chruby system

  # N-1 stable release.
  # TODO: Use Xcode 10.3.0 once issues with TVIVideoViewTests not producing frames are resolved. (ISDK-2640)
  - &macos-minus
    macos:
      xcode: "10.1.0"

  - &macos-large
    resource_class: large

  # This is not currently being used, but chose to leave it here as reference for future usage.
  - &install-simulators
    name: Install simulators
    command: |
      sudo gem install xcode-install
      xcrun simctl list
      echo "" | xcversion simulators --no-progress --install='iOS 9.3'
      xcrun simctl list

  - &simulator-warming
    name: Warm up simulators
    command: |
      xcrun instruments -w "iPhone 8 Plus (12.1) [" || true

  - &simulator-warming-beta
    name: Warm up simulators
    command: |
      xcrun instruments -w "iPhone 8 Plus (13.0) [" || true
  
  - &install-brew-deps
    name: Install awscli, carthage and maven via Homebrew
    command: Scripts/ci/install-brew-deps.sh
      
  # Homebrew dependencies cache
  - &brew-deps-cache-key
    key: brew-deps-{{ checksum "Scripts/ci/install-brew-deps.sh" }}
  - &restore-cache-brew-deps
    <<: *brew-deps-cache-key
    name: Restoring Homebrew dependencies from the cache
  - &save-cache-brew-deps
    <<: *brew-deps-cache-key
    name: Saving Homebrew dependencies to the cache
    paths:
      # Minimal cache of the dependencies installed via Homebrew.
      # `brew link` will be used to restore the symlinks.
      - /usr/local/Cellar/maven
      - /usr/local/Cellar/awscli
      - /usr/local/Cellar/openssl
      - /usr/local/Cellar/python
      - /usr/local/Cellar/readline
      - /usr/local/Cellar/sqlite

  # Filters
  - &build-filter
    branches:
      ignore:
        # All temporary work should be in a branch starting with WIP/
        - /WIP\/.*/

  - &pr-filter
    branches:
      ignore:
        # All temporary work should be in a branch starting with WIP/
        - /WIP\/.*/
        # This is the collection of our "special" branches that we only build with snapshots
        - master
        - "1.0"
        - "2.0"
        - /feature\/.*/

  - &snapshot-filter
    branches:
      only:
        - master
        - "1.0"
        - "2.0"
        - /feature\/.*/

jobs:
  # Debug build of VideoApp-Twilio
  build:
    <<: *macos-defaults
    steps:
      - run: *log-hw-info
      - checkout
      - run:
          name: Install CocoaPods
          command: pod install
      - run: *reset-ruby
      - restore-cache: *restore-cache-brew-deps
      - run: *install-brew-deps
      - save-cache: *save-cache-brew-deps
      # - restore-cache: *restore-video-app-carthage-deps-cache
      # - run: *install-video-app-deps
      # - save-cache: *save-video-app-carthage-deps-cache
      - run: *secrets
      - run:
          command: chruby system
      - run:
          command: ./Scripts/build-app.sh
          no_output_timeout: 30m
    environment:
      - CONFIGURATION=Debug
      - IOS_APP=VideoApp-Twilio

